<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>12,000 Years of Land</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #fff;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: left;
            margin-bottom: 30px;
            padding: 30px 0;
        }
        
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #222;
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 20px;
        }
        
        .controls {
            padding: 15px 20px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .controls-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 24px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            border: none;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        #playBtn {
            background: #4CAF50;
            color: white;
        }
        
        #pauseBtn {
            background: white;
            border: 1px solid #999;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        #yearDisplay {
            font-size: 28px;
            font-weight: bold;
            margin-left: 20px;
            color: #333;
        }
        
        #yearSlider {
            width: 100%;
            height: 8px;
            cursor: pointer;
        }
        
        #statusText {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
            min-height: 20px;
            display: none;
        }
        
        .visualization {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        
        .map-container {
            flex: 0 0 75%;
            position: relative;
            min-width: 0;
        }
        
        .sidebar {
            flex: 0 0 23%;
            min-width: 250px;
            max-width: 400px;
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 25px;
            position: sticky;
            top: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .sidebar.paused {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid #4CAF50;
        }
        
        .pause-indicator {
            background: #4CAF50;
            color: white;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 18px;
            letter-spacing: 0.5px;
        }
        
        .chapter-label {
            font-size: 10px;
            letter-spacing: 1.8px;
            margin-bottom: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .chapter-title {
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 6px 0;
            line-height: 1.2;
            color: #222;
        }
        
        .chapter-years {
            font-size: 14px;
            margin-bottom: 18px;
            color: #555;
            font-weight: 500;
        }
        
        .chapter-divider {
            width: 50px;
            height: 2px;
            background: #4CAF50;
            margin: 18px 0;
        }
        
        .chapter-description {
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-line;
            color: #333;
        }
        
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }
        
        .zoom-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #ccc;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .zoom-btn:hover {
            background: #f0f0f0;
        }
        
        #zoom-reset {
            font-size: 16px;
        }
        
        .legend {
            margin-top: 20px;
            padding: 10px 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .legend-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            margin-left: 20px;
            color: #333;
        }
        
        footer {
            margin-top: 40px;
            padding: 30px 0;
            text-align: left;
            border-top: 1px solid #ddd;
            font-size: 14px;
            color: #666;
        }
        
        .disclaimer {
            max-width: 800px;
            margin: 0 0 15px 0;
            line-height: 1.8;
        }
        
        .data-source {
            font-size: 13px;
            color: #888;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .visualization {
                flex-direction: column;
            }
            
            .map-container {
                flex: 0 0 100%;
            }
            
            .sidebar {
                flex: 0 0 100%;
                position: static;
                max-width: none;
            }
            
            .controls-row {
                justify-content: center;
            }
            
            #yearDisplay {
                margin-left: 0;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>12,000 Years of Land</h1>
            <p class="subtitle">an animated history of agricultural land expansion</p>
        </header>
        
        <div class="controls">
            <div class="controls-row">
                <button id="playBtn">▶️ Play</button>
                <button id="pauseBtn">⏸ Pause</button>
                <span id="yearDisplay">-10000 BC</span>
            </div>
            <input type="range" id="yearSlider" min="0" max="0" value="0">
            <div id="statusText"></div>
        </div>
        
        <div class="visualization">
            <div class="map-container">
                <div id="map"></div>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoom-in">+</button>
                    <button class="zoom-btn" id="zoom-out">−</button>
                    <button class="zoom-btn" id="zoom-reset" title="Reset zoom">⟲</button>
                </div>
            </div>
            
            <div class="sidebar" id="sidebar">
                <div id="pause-indicator" class="pause-indicator" style="display: none;">
                    ⏸ PAUSED - PRESS PLAY TO CONTINUE
                </div>
                <div class="chapter-label" id="chapter-label">Chapter 1</div>
                <h2 class="chapter-title" id="chapter-title">DAWN OF AGRICULTURE</h2>
                <div class="chapter-years" id="chapter-years">10,000 BC - 500 AD</div>
                <div class="chapter-divider"></div>
                <div class="chapter-description" id="chapter-description"></div>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-title">% of farmed land</div>
            <svg id="legend" width="100%" height="60"></svg>
        </div>
        
        <footer>
            <div class="disclaimer">
                <strong>Note on Historical Borders:</strong> The country shapes you see are modern. While ancient civilizations knew no borders like these, they show where agriculture developed historically.
            </div>
            <div class="data-source">
                <strong>Data Source:</strong> Klein Goldewijk, C.G.M., Beusen, A., Doelman, J., Stehfest, E. (2017). 
                Anthropogenic land use estimates for the Holocene – HYDE 3.2. <em>Earth System Science Data</em>, 9, 927–953.
            </div>
        </footer>
    </div>

    <script>
        // Embed data
        const years = [-10000,-9000,-8000,-7000,-6000,-5000,-4000,-3000,-2000,-1000,0,100,200,300,400,500,600,700,800,900,1000,1100,1200,1300,1400,1500,1600,1700,1710,1720,1730,1740,1750,1760,1770,1780,1790,1800,1810,1820,1830,1840,1850,1860,1870,1880,1890,1900,1910,1920,1930,1940,1950,1951,1952,1953,1954,1955,1956,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023];
        
        const chapters = [{"id":1,"title":"DAWN OF AGRICULTURE","years":"10,000 BC - 500 AD","yearRange":[-10000,500],"triggerYear":-10000,"description":"Farming begins independently across several regions: the Fertile Crescent, the Indus Basin, the Nile Valley, and the Yellow River basin.\nIt anchors early civilizations — Mesopotamia, Egypt, China, Persia, and later Rome.\nFor millennia, agriculture grows very slowly, using less than 5% of global land.\nBy 500 AD, the Roman Empire has spread Mediterranean farming across three continents, but large parts of Africa, the Americas, and Oceania remain mostly uncultivated.\n","speed":400},{"id":2,"title":"MEDIEVAL WORLD","years":"500 - 1700 AD","yearRange":[500,1700],"triggerYear":500,"description":"After Rome falls, European farmland contracts — but agriculture thrives elsewhere.\nDuring the Islamic Golden Age, irrigation, new crops and farming knowledge spread from Spain to India. Trade routes like Silk Road and trans-Saharan networks help farming grow steadily across Asia and Africa. In China, advances in rice growing expand cultivated land. \nEurope recovers from around 1000 AD, but in 1347 the Black Death empties fields again.\nBy 1700, the world is more connected, and farming systems are far more diverse.","speed":400},{"id":3,"title":"INDUSTRIAL ERA","years":"1700 - 1900 AD","yearRange":[1700,1900],"triggerYear":1700,"description":"New tools, selective breeding, crop rotation and mechanization boost European farming.\nBut the biggest changes come from colonial expansion — huge areas in the Americas, Africa and Oceania are cleared for export crops and livestock. Railroads, global trade and plantation systems speed everything up.\nAcross Asia, population growth and intensive small farms continue pushing cultivation outward.\nIn these 200 years, more land is converted to farming than in the previous 10,000.","speed":240},{"id":4,"title":"THE GREAT ACCELERATION","years":"1900 - 2023","yearRange":[1900,2023],"triggerYear":1900,"description":"The 20th century brings the fastest farmland expansion in history. The US and Brazil scale up industrial farming; the Soviet Union reshapes vast areas of Eurasia; and much of Africa expands rapidly after 1950. From the 1960s, the Green Revolution transforms Asia and parts of Latin America with high-yield crops and irrigation.\nEurope's agricultural land shrinks slightly through better productivity. But elsewhere it keeps growing, driven by population growth, global trade and changing diets.","speed":240},{"id":5,"title":"WHAT'S NEXT?","years":"2023","yearRange":[2023,2023],"triggerYear":2023,"description":"By 2023, agricultural land covers about 37% of Earth's habitable surface.\nHave we reached 'peak farmland' — or is more expansion ahead?\nThe future depends on how we balance food demand, diet choices, agricultural technology, climate change, and ecosystem protection.\nHigher yields and smarter farming could reduce pressure to expand.\nBut growing populations and rising meat consumption may push in the opposite direction. \n","speed":60,"isFinal":true}];
        
        // Load external JSON data files
        let countriesData, world, countriesSplit;
        
        console.log('Starting to load data files...');
        
        Promise.all([
            fetch('countriesData.json').then(r => {
                console.log('countriesData.json loaded');
                return r.json();
            }),
            fetch('world.json').then(r => {
                console.log('world.json loaded');
                return r.json();
            }),
            fetch('countriesSplit.json').then(r => {
                console.log('countriesSplit.json loaded');
                return r.json();
            })
        ]).then(([data, worldData, splitData]) => {
            console.log('All data loaded successfully!');
            console.log('countriesData rows:', data.length);
            console.log('Sample data:', data[0]);
            countriesData = data;
            world = worldData;
            countriesSplit = splitData;
            initializeVisualization();
        }).catch(error => {
            console.error('Error loading data:', error);
            alert('Error loading data files. Please ensure countriesData.json, world.json, and countriesSplit.json are in the same directory as this HTML file.');
        });
        
        // Helper functions
        function getBorderOpacity(year) {
            if (year < 1700) return 0;
            if (year < 1800) return 0.1;
            if (year < 1850) return 0.2;
            if (year < 1900) return 0.3;
            if (year < 1950) return 0.5;
            return 0.8;
        }
        
        function getCurrentChapter(year) {
            for (let i = chapters.length - 1; i >= 0; i--) {
                if (year >= chapters[i].yearRange[0]) {
                    return chapters[i];
                }
            }
            return chapters[0];
        }
        
        // Color scale
        const colorScale = d3.scaleSequential()
            .domain([0, 85])
            .interpolator(t => {
                if (t < 0.18) return d3.interpolate("#FFF8DC", "#F5DEB3")(t / 0.18);
                if (t < 0.47) return d3.interpolate("#F5DEB3", "#DEB887")((t - 0.18) / 0.29);
                if (t < 0.71) return d3.interpolate("#DEB887", "#D2691E")((t - 0.47) / 0.24);
                return d3.interpolate("#D2691E", "#8B4513")((t - 0.71) / 0.29);
            });
        
        // Global variables
        let currentYearIndex = 0;
        let playing = false;
        let timeoutId = null;
        let lastChapterId = null;
        let pausedForChapter = false;
        let svg, mapGroup, projection, path, zoom;
        
        function initializeVisualization() {
            // Set up slider
            document.getElementById('yearSlider').max = years.length - 1;
            
            // Create map
            createMap();
            
            // Create legend
            createLegend();
            
            // Set up controls
            setupControls();
            
            // Initial update
            updateVisualization();
        }
        
        function createMap() {
            const width = 1600;
            const height = 1000;
            
            const container = d3.select('#map');
            
            svg = container.append('svg')
                .attr('viewBox', [0, 0, width, height])
                .attr('width', '100%')
                .style('display', 'block');
            
            mapGroup = svg.append('g').attr('class', 'map-group');
            
            projection = d3.geoEqualEarth()
                .center([15, 10])
                .scale(350)
                .translate([width / 2, height / 2]);
            
            path = d3.geoPath(projection);
            
            const bounds = path.bounds({type: "FeatureCollection", features: countriesSplit.features});
            const mapWidth = bounds[1][0] - bounds[0][0];
            const mapHeight = bounds[1][1] - bounds[0][1];
            
            zoom = d3.zoom()
                .scaleExtent([1, 8])
                .translateExtent([
                    [bounds[0][0], bounds[0][1]],
                    [bounds[1][0], bounds[1][1]]
                ])
                .extent([[0, 0], [width, height]])
                .on('zoom', (event) => {
                    mapGroup.attr('transform', event.transform);
                    const scale = event.transform.k;
                    mapGroup.selectAll('.countries path').attr('stroke-width', 0.3 / scale);
                    svg.style('cursor', scale > 1 ? 'grab' : 'default');
                });
            
            svg.call(zoom);
            
            svg.on('mousedown.cursor', function() {
                const transform = d3.zoomTransform(svg.node());
                if (transform.k > 1) svg.style('cursor', 'grabbing');
            });
            
            svg.on('mouseup.cursor', function() {
                const transform = d3.zoomTransform(svg.node());
                if (transform.k > 1) svg.style('cursor', 'grab');
            });
            
            // Ocean background
            svg.append('rect')
                .attr('width', width)
                .attr('height', height)
                .attr('fill', '#E8F4F8')
                .lower();
            
            // Clipping
            svg.append('defs')
                .append('clipPath')
                .attr('id', 'map-clip')
                .append('rect')
                .attr('x', bounds[0][0])
                .attr('y', bounds[0][1])
                .attr('width', mapWidth)
                .attr('height', mapHeight);
            
            mapGroup.attr('clip-path', 'url(#map-clip)');
            
            // Tooltip
            const tooltipGroup = mapGroup.append('g')
                .attr('class', 'tooltip-container')
                .attr('pointer-events', 'none')
                .style('opacity', 0);
            
            // Draw countries
            const threshold = 0.01;
            
            mapGroup.append('g')
                .attr('class', 'countries')
                .selectAll('path')
                .data(countriesSplit.features)
                .join('path')
                .attr('d', path)
                .attr('fill', '#f0f0f0')
                .attr('stroke', '#333')
                .attr('stroke-width', 0.3)
                .attr('stroke-opacity', 0)
                .style('pointer-events', 'all')
                .on('mouseenter', function(event, d) {
                    const countryName = d.properties.name;
                    const currentYear = years[currentYearIndex];
                    let match;
                    
                    if (countryName === 'French Guiana') {
                        match = countriesData.find(row => row.Year === currentYear && row.Code === 'GUF');
                    } else {
                        match = countriesData.find(row => 
                            row.Year === currentYear && 
                            (row.Entity === countryName || 
                             row.Entity.includes(countryName) ||
                             countryName.includes(row.Entity))
                        );
                    }
                    
                    const value = match ? (match.Pct_Total_Agriculture || 0) : 0;
                    const [mouseX, mouseY] = d3.pointer(event, mapGroup.node());
                    
                    tooltipGroup.selectAll('*').remove();
                    tooltipGroup.append('text')
                        .attr('x', mouseX + 10)
                        .attr('y', mouseY - 10)
                        .attr('fill', '#222')
                        .attr('font-size', '14px')
                        .attr('font-weight', 'bold')
                        .attr('text-anchor', 'start')
                        .style('text-shadow', '1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white')
                        .text(`${countryName}: ${value.toFixed(1)}%`);
                    
                    tooltipGroup.style('opacity', 1).raise();
                })
                .on('mousemove', function(event) {
                    const [mouseX, mouseY] = d3.pointer(event, mapGroup.node());
                    tooltipGroup.select('text')
                        .attr('x', mouseX + 10)
                        .attr('y', mouseY - 10);
                })
                .on('mouseleave', function() {
                    tooltipGroup.style('opacity', 0);
                });
            
            // Continent borders
            const worldFiltered = {
                type: world.type,
                objects: {
                    countries: {
                        type: world.objects.countries.type,
                        geometries: world.objects.countries.geometries.filter(g => 
                            g.properties.name !== 'Antarctica' && 
                            g.properties.name !== 'Fr. S. Antarctic Lands'
                        )
                    }
                },
                arcs: world.arcs,
                transform: world.transform
            };
            
            const continentOutline = topojson.mesh(worldFiltered, worldFiltered.objects.countries, (a, b) => a === b);
            
            mapGroup.append('path')
                .datum(continentOutline)
                .attr('d', path)
                .attr('fill', 'none')
                .attr('stroke', '#444')
                .attr('stroke-width', 1.0)
                .attr('stroke-opacity', 0.5)
                .attr('stroke-linejoin', 'round')
                .attr('stroke-linecap', 'round')
                .style('pointer-events', 'none');
            
            // Year display
            mapGroup.append('text')
                .attr('class', 'year-display')
                .attr('x', 50)
                .attr('y', height - 80)
                .attr('text-anchor', 'start')
                .attr('font-size', '64px')
                .attr('font-weight', 'bold')
                .attr('fill', '#333')
                .attr('opacity', 0.3)
                .style('pointer-events', 'none')
                .text('-10000 BC');
        }
        
        function createLegend() {
            const svg = d3.select('#legend');
            const width = parseInt(svg.style('width'));
            const height = 60;
            const margin = {top: 5, right: 20, bottom: 25, left: 20};
            const legendWidth = Math.min(500, width - margin.left - margin.right);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);
            
            // Gradient
            const defs = svg.append('defs');
            const gradient = defs.append('linearGradient')
                .attr('id', 'legend-gradient')
                .attr('x1', '0%')
                .attr('x2', '100%');
            
            for (let i = 0; i <= 100; i++) {
                gradient.append('stop')
                    .attr('offset', `${i}%`)
                    .attr('stop-color', colorScale(i * 0.85));
            }
            
            // Rectangle
            g.append('rect')
                .attr('width', legendWidth)
                .attr('height', 20)
                .style('fill', 'url(#legend-gradient)');
            
            // Scale
            const legendScale = d3.scaleLinear()
                .domain([0, 85])
                .range([0, legendWidth]);
            
            const axis = d3.axisBottom(legendScale)
                .tickFormat(d => d + '%')
                .tickValues([0, 10, 20, 30, 40, 50, 60, 70, 80]);
            
            g.append('g')
                .attr('transform', `translate(0, 20)`)
                .call(axis)
                .style('font-size', '11px');
        }
        
        function setupControls() {
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const slider = document.getElementById('yearSlider');
            
            console.log('Setting up controls...');
            console.log('Slider element:', slider);
            console.log('Slider max:', slider.max);
            
            playBtn.onclick = play;
            pauseBtn.onclick = pause;
            
            // Multiple ways to ensure the event fires
            slider.addEventListener('input', onSliderChange);
            slider.addEventListener('change', onSliderChange);
            slider.oninput = onSliderChange;
            slider.onchange = onSliderChange;
            
            document.getElementById('zoom-in').onclick = () => {
                svg.transition().duration(300).call(zoom.scaleBy, 1.3);
            };
            document.getElementById('zoom-out').onclick = () => {
                svg.transition().duration(300).call(zoom.scaleBy, 0.77);
            };
            document.getElementById('zoom-reset').onclick = () => {
                svg.transition().duration(300).call(zoom.transform, d3.zoomIdentity);
            };
            
            console.log('Controls setup complete');
        }
        
        function play() {
            if (currentYearIndex >= years.length - 1) {
                currentYearIndex = 0;
                lastChapterId = null;
            }
            
            const currentYear = years[currentYearIndex];
            const currentChapter = getCurrentChapter(currentYear);
            lastChapterId = currentChapter.id;
            pausedForChapter = false;
            
            playing = true;
            document.getElementById('playBtn').style.background = '#FF9800';
            document.getElementById('playBtn').textContent = '⏸ Playing...';
            document.getElementById('statusText').textContent = `Playing: ${currentChapter.title}`;
            
            animate();
        }
        
        function pause() {
            playing = false;
            document.getElementById('playBtn').style.background = '#4CAF50';
            document.getElementById('playBtn').textContent = '▶️ Play';
            if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }
            pausedForChapter = false;
            document.getElementById('statusText').textContent = 'Paused';
            updateVisualization();
        }
        
        function animate() {
            if (!playing) return;
            
            currentYearIndex++;
            
            if (currentYearIndex >= years.length - 1) {
                currentYearIndex = years.length - 1;
                pause();
                pausedForChapter = true;
                lastChapterId = 5;
                document.getElementById('statusText').textContent = 'Animation complete!';
                updateVisualization();
                return;
            }
            
            const currentYear = years[currentYearIndex];
            const currentChapter = getCurrentChapter(currentYear);
            
            const hitTrigger = chapters.some(ch => 
                ch.id !== lastChapterId && 
                ch.triggerYear === currentYear
            );
            
            if (hitTrigger) {
                pause();
                lastChapterId = currentChapter.id;
                pausedForChapter = true;
                document.getElementById('statusText').textContent = `Chapter ${currentChapter.id}: ${currentChapter.title} - Press Play to continue`;
                updateVisualization();
                return;
            }
            
            lastChapterId = currentChapter.id;
            pausedForChapter = false;
            
            updateVisualization();
            
            let speed = currentChapter.speed || 150;
            if (currentYear >= 1951) {
                speed = 50;
            }
            
            timeoutId = setTimeout(animate, speed);
        }
        
        function onSliderChange(event) {
            const sliderValue = document.getElementById('yearSlider').value;
            console.log('=== SLIDER CHANGE ===');
            console.log('Slider value:', sliderValue);
            console.log('Years array length:', years.length);
            console.log('Playing state before pause:', playing);
            
            pause();
            
            currentYearIndex = parseInt(sliderValue);
            console.log('New currentYearIndex:', currentYearIndex);
            
            const currentYear = years[currentYearIndex];
            console.log('Current year:', currentYear);
            
            const currentChapter = getCurrentChapter(currentYear);
            console.log('Current chapter:', currentChapter.title);
            
            lastChapterId = currentChapter.id;
            pausedForChapter = false;
            document.getElementById('statusText').textContent = currentChapter.title;
            
            console.log('About to call updateVisualization...');
            updateVisualization();
            console.log('updateVisualization completed');
        }
        
        function updateVisualization() {
            const currentYear = years[currentYearIndex];
            const currentChapter = getCurrentChapter(currentYear);
            const currentBorderOpacity = getBorderOpacity(currentYear);
            const threshold = 0.01;
            
            // Update display
            document.getElementById('yearDisplay').textContent = currentYear > 0 ? currentYear : `${Math.abs(currentYear)} BC`;
            document.getElementById('yearSlider').value = currentYearIndex;
            
            // Update sidebar
            const sidebar = document.getElementById('sidebar');
            const pauseIndicator = document.getElementById('pause-indicator');
            
            if (pausedForChapter) {
                sidebar.classList.add('paused');
                pauseIndicator.style.display = 'block';
            } else {
                sidebar.classList.remove('paused');
                pauseIndicator.style.display = 'none';
            }
            
            document.getElementById('chapter-label').textContent = `Chapter ${currentChapter.id}`;
            document.getElementById('chapter-title').textContent = currentChapter.title;
            document.getElementById('chapter-years').textContent = currentChapter.years;
            document.getElementById('chapter-description').textContent = currentChapter.description;
            
            // Update map
            mapGroup.selectAll('.countries path')
                .attr('fill', d => {
                    const countryName = d.properties.name;
                    let match;
                    
                    if (countryName === 'French Guiana') {
                        match = countriesData.find(row => row.Year === currentYear && row.Code === 'GUF');
                    } else {
                        match = countriesData.find(row => 
                            row.Year === currentYear && 
                            (row.Entity === countryName || 
                             row.Entity.includes(countryName) ||
                             countryName.includes(row.Entity))
                        );
                    }
                    
                    const value = match ? (match.Pct_Total_Agriculture || 0) : 0;
                    return value >= threshold ? colorScale(value) : '#f0f0f0';
                })
                .attr('stroke-opacity', currentBorderOpacity);
            
            // Update year display on map
            mapGroup.select('.year-display')
                .text(currentYear > 0 ? currentYear : `${Math.abs(currentYear)} BC`);
        }
    </script>
</body>
</html>
